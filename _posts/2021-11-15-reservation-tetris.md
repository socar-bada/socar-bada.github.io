---
layout: post
title: "뭐하지"
subtitle: "뭐하지이"
date: 2021-12-01 09:00:00 +0900
category: data
background: '/assets/images/~~~.jpg'
author: carrot
comments: true
tags:
    - data
    - optimization

---

<br>

쏘카에서 차량을 대여하기 위해 앱을 탐색하다보면 하나의 쏘카존 안에서도 아반떼, 레이, 코나 등 다양한 차량들이 눈에 들어옵니다. 이 때 한 존에 같은 종류의 차량이 한 대만 있지 않은 경우라면 어떤 차량이 어떤 과정을 거쳐 나에게 배정되는지 궁금하신 적 없으신가요?

이번 글에서는 바로 그 과정의 뒤에 있는 **예약 테트리스 프로젝트**를 다룹니다.

프로젝트를 시작하게 된 계기부터, 최적화 모델과 실제 서비스에 적용하기 위해 구축한 인프라 구조까지 프로젝트의 전반적인 내용을 자세하게 다루었으니 이 글로 평소에 가지고 있던 궁금증이 풀리길 바랍니다.

<br>


## 목차

- 예약 테트리스 프로젝트 소개
- 예약 테트리스 최적화 모델링
- 전체 인프라 구조
- 예약 테트리스 적용 성과?
- 느낀 점?

<br>

---

## 예약 테트리스 프로젝트 소개

### 예약 "테트리스"?

프로젝트를 설명하기에 앞서, 갑자기 프로젝트 이름으로 테트리스라니 의아하다고 느낄 수도 있을 것 같습니다. 
먼저 간단히 테트리스 게임을 설명하자면, 테트리스는 위에서 내려오는 블록을 빈 공간에 맞춰 차곡차곡 쌓아 꽉 찬 한 줄 한 줄을 만들어 포인트를 얻는 퍼즐게임입니다. 
이번 프로젝트의 이름에 테트리스가 붙여진 이유는 **들어오는 예약을 차량의 빈 공간에 차곡차곡 정리하는 과정**이 마치 테트리스 게임과 비슷하다고 생각했기 때문입니다.

차량이 비는 시간에 예약을 얼마나 잘 채워넣는지는 쏘카가 차량을 효율적으로 운영하는 데 굉장히 중요한 문제입니다. 
**같은 대수의 차량으로도 예약마다 어떤 차량을 배정해주는지에 따라 얼마나 많은 고객이 쏘카를 이용할 수 있는지가 결정되기 때문**이죠.

한 쏘카존에 같은 종류의 차량이 두 대 있을 때를 예시를 들어서 부연설명을 해보겠습니다.
A와 B라는 서로 다른 두 고객이 각각 08시~12시와 20시~24시 총 두 건의 예약을 한 상태에서, 0시부터 24시까지 24시간 동안 이용하고 싶어하는 C라는 고객이 같은 존에서 같은 차량을 대여하고 싶어 하는 상황을 생각해봅시다.
이때 만약 A에 B에게 서로 다른 차량이 배정된 상태라면 C는 이용할 수 있는 차량이 없을 것입니다.
두 차량 모두 C의 예약을 받을 수 있을 만큼의 충분한 여유공간이 없기 때문이죠.

(여기 그림 들어감)
![](/img/reservation-tetris/example-reserve-fail.png){: width="100%"}

하지만 만약 A와 B의 예약에 같은 차량을 배정했다면 두 사람의 예약에 배정되지 않은 하나의 차량이 남아 C는 수월하게 쏘카를 이용할 수 있게 됩니다. 
이처럼 예약마다 상황에 더 적절한 차량을 배정해주면 더 많은 차량을 준비하지 않아도 더 많은 고객들이 쏘카의 서비스를 이용할 수 있도록 할 수 있습니다.

(여기 그림 들어감)
![](/img/reservation-tetris/example-reserve-success.png){: width="100%"}

<br>

### 예약 테트리스 프로젝트의 목적

예약 테트리스 프로젝트가 도입되기 이전에도 이러한 효율화 작업은 이루어지고 있었습니다. 
지금과 다른 점이 있다면 이 모든 작업이 사람의 손으로 이루어졌다는 점이죠. 
앞서 설명한 문제 수준의 난이도라면 사람 손으로도 쉽게 처리할 수 있겠지만, 쏘카는 하루 N만 건 이상의 신규 예약이 생성되고, M만 대 이상의 차량이 운영되고 있는 국내 최대규모 카셰어링 서비스입니다. 
같은 종류의 차량이 두 대뿐이라고 해도 최대 90일 전부터 미리 예약을 할 수 있다는 점을 감안하면 사람의 손으로 최적의 차량 배정을 하기가 쉽지 않다는 것을 이해하기란 어렵지 않습니다.
실제로 쏘카에서 가장 큰 존인 제주 스테이션의 경우는 예약 테트리스 서비스가 배포되기 전까진 하루에 고정적으로 최대 4시간까지 예약을 정리하는 데 사용하며 고생하고 있었습니다.

**예약 테트리스 프로젝트는 이런 차량 배정 최적화 과정을 자동화하기 위해 시작되었습니다.**
예약 정리 프로세스를 자동화하면 존 매니저들이 업무시간을 더 효율적으로 사용할 수 있을 뿐더러, 사람의 머리로는 도출하기에 한계가 있는 최대로 최적화된 차량 배정으로 서비스를 운영할 수 있게 됩니다. 업무 효율과 공급 효율 두 마리 토끼를 모두 잡기 위한 프로젝트인 셈이죠.

<br>

## 예약 테트리스 최적화 모델링

### 수리 계획법과 제약조건 계획법

최적화 모델링을 다루기 전에 수리 계획법(Mathematical Programming)과 제약조건 계획법(Constraint Programming)이 무엇인지 짚고 넘어가겠습니다.



예약 테트리스 프로젝트에서는 차량 배정 최적화 모델링을 위해 제약조건 계획법을 사용합니다.
[제약조건 계획법(Constraint Programming)](https://en.wikipedia.org/wiki/Constraint_programming)이란 제약조건으로 표현된 해 공간에서 목적함수의 값을 최대화 또는 최소화하는 결정변수의 값을 구하는 최적화 기법입니다.
생소한 단어들이 많아 처음 접하는 개념처럼 느낄 수도 있지만 일차 부등식을 활용한 문제를 풀어본 경험이 있다면 높은 확률로 낯설지 않다고 느낄 것입니다. ([여기 참고](https://dawoum.ddns.net/wiki/%EB%B6%80%EB%93%B1%EC%8B%9D%EC%9D%98_%EC%98%81%EC%97%AD%EC%97%90%EC%84%9C%EC%9D%98_%EC%B5%9C%EB%8C%80_%EC%B5%9C%EC%86%8C))

일차 부등식의 영역에서 최대 또는 최소값을 구하는 문제 

(여기 그림 들어감)
![](/img/~~/~~.png){: width="100%"}

<br>

### 어떤 상태가 더 '최적'일까?

예약 테트리스 모델링을 시작하면서 가장 어려웠던 부분은 어떤 차량 배정 상태가 더 "최적"인지를 수치적으로 판단할 수 있는 지표를 정의하는 것이었습니다.
모델 성능과 최적화 정도 사이에서 고민한 끝에, 완벽한 최적해는 아니더라도 가상의 예약건이 가장 많이 들어올 수 있도록 예약에 차량을 배정하는 모델을 짜게 되었습니다.
가상예약건의 예약 가능성이 클수록 더 최적이라고 판단한 것입니다.
앞서 들었던 예시로 설명하자면, A와 B의 예약을 서로 다른 차량에 배정한다면 예약 가능한 하루 단위의 가상예약건수는 0이 되지만, 두 예약을 같은 차량에 배정한다면 1이 되기 때문에 후자의 경우를 더 최적이라고 판단할 수 있는 것이죠.
예약이 어떤 차량에 배정되었는지만이 중요하고, 다른 예약과의 선후 관계는 변수 단위에서는 고려하지 않아도 된다는 점이 모델의 최적해 도출 속도 측면에서 큰 이점으로 작용하였습니다.

(여기 그림 들어감)
![](/img/~~/~~.png){: width="100%"}

<br>

### 예약 테트리스 최적화 모델

예약 테트리스의 최적화 모델은 다음과 같이 정의됩니다.

- 결정변수: 실제 또는 가상예약에 어떤 차량의 배정 여부 (0 또는 1)
- 목적함수: 예약가능한 가상예약건수의 최대화
- 제약조건
	- 모든 예약은 단 하나의 차량에 배정되어야 한다
	- 차량이 고정되야하는 예약은 배정된 차량이 변경되면 안된다
	- 임의의 서로 다른 두 개의 실제예약은 같은 차량에 배정된 경우 서로 겹칠 수 없다
	- 임의의 가상예약과 실제예약은 같은 차량에 배정된 경우 서로 겹칠 수 없다

이를 수식으로 표현하면 다음과 같이 됩니다.

(여기 그림 들어감)
![](/img/~~/~~.png){: width="100%"}

### Google OR-Tools

수식화한 모델을 코드로 구현하고 최적해를 찾기 위해서는 솔버(solver)가 필요합니다.
예약 테트리스의 최적화 모델은 구글의 오픈소스 솔버인 [Google OR-Tools](https://developers.google.com/optimization)의 파이썬 패키지로 구현하였습니다.
Google OR-Tools는 무료로 사용할 수 있는 오픈소스임에도 [뛰어난 성능](https://www.minizinc.org/challenge2021/results2021.html)을 가지고 있으며, 특히 제약조건 계획법을 이용한 솔버 CP-SAT




## 전체 인프라 구조




<br>

---
쏘카 데이터 그룹은 채용 중입니다.  
[쏘카(SOCAR) - 데이터 분석가](http://bit.ly/socar-data-engineer-recruitement)